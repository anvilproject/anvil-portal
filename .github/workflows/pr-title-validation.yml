name: Validate PR Title

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened

jobs:
  validate-pr-title:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Validate PR Title Format
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;

            // Valid semantic commit types from commitlint.config.js
            const validTypes = [
              'build',
              'chore',
              'ci',
              'content',
              'docs',
              'feat',
              'fix',
              'perf',
              'refactor',
              'revert',
              'style',
              'test'
            ];

            // Create regex pattern:
            // - Must start with valid type followed by colon
            // - After colon and space, must start with lowercase letter
            // - Must end with ticket number in format (#123)
            const typePattern = validTypes.join('|');
            const regex = new RegExp(
              `^(${typePattern})(\\([^)]+\\))?:\\s+[a-z].*\\s+\\(#\\d+\\)$`
            );

            if (!regex.test(prTitle)) {
              let errorMessage = '❌ **PR Title Validation Failed**\n\n';
              errorMessage += 'Your PR title does not match the required format.\n\n';
              errorMessage += '**Required format:**\n';
              errorMessage += '```\n';
              errorMessage += 'type: description starting with lowercase (#123)\n';
              errorMessage += '```\n\n';
              errorMessage += '**Valid types:** ' + validTypes.join(', ') + '\n\n';
              errorMessage += '**Examples:**\n';
              errorMessage += '- ✅ `feat: add new consortia page (#456)`\n';
              errorMessage += '- ✅ `fix: correct date formatting in events (#789)`\n';
              errorMessage += '- ✅ `docs: update README with setup instructions (#123)`\n';
              errorMessage += '- ✅ `fix(events): resolve timezone bug (#234)`\n\n';
              errorMessage += '**Your PR title:**\n';
              errorMessage += '```\n' + prTitle + '\n```\n\n';
              errorMessage += '**Common issues:**\n';
              errorMessage += '- Description must start with a lowercase letter\n';
              errorMessage += '- Must end with ticket number in parentheses like (#123)\n';
              errorMessage += '- Must include a space before the ticket number\n';
              errorMessage += '- Must use a valid semantic commit type\n';

              core.setFailed(errorMessage);

              // Check for existing validation comment and update it, or create new one
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
              });

              const botComment = comments.data.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('PR Title Validation Failed')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: errorMessage
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: errorMessage
                });
              }
            } else {
              console.log('✅ PR title is valid:', prTitle);
            }
